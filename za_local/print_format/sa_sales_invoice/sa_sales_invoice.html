{%- set is_abridged = doc.grand_total < 5000 -%}
{%- set company_doc = frappe.get_doc("Company", doc.company) -%}
{%- set invoice_type = "TAX INVOICE" if doc.grand_total >= 5000 else "INVOICE" -%}

<style>
	.sa-invoice {
		font-family: Arial, Helvetica, sans-serif;
		font-size: 11pt;
		line-height: 1.5;
		color: #000;
	}
	.sa-invoice .header {
		margin-bottom: 30px;
		border-bottom: 2px solid #333;
		padding-bottom: 15px;
	}
	.sa-invoice .company-logo {
		max-width: 200px;
		max-height: 80px;
		margin-bottom: 10px;
	}
	.sa-invoice .company-name {
		font-size: 18pt;
		font-weight: bold;
		color: #2c3e50;
		margin-bottom: 5px;
	}
	.sa-invoice .invoice-title {
		font-size: 24pt;
		font-weight: bold;
		text-align: center;
		color: #2c3e50;
		margin: 20px 0;
		text-transform: uppercase;
	}
	.sa-invoice .address-section {
		display: table;
		width: 100%;
		margin-bottom: 20px;
	}
	.sa-invoice .bill-to, .sa-invoice .invoice-details {
		display: table-cell;
		vertical-align: top;
		width: 50%;
	}
	.sa-invoice .bill-to {
		padding-right: 20px;
	}
	.sa-invoice .section-label {
		font-weight: bold;
		font-size: 10pt;
		color: #74808b;
		text-transform: uppercase;
		margin-bottom: 8px;
	}
	.sa-invoice .vat-number {
		font-weight: bold;
		color: #e74c3c;
	}
	.sa-invoice table.items {
		width: 100%;
		border-collapse: collapse;
		margin: 20px 0;
	}
	.sa-invoice table.items th {
		background-color: #34495e;
		color: white;
		padding: 10px;
		text-align: left;
		font-weight: bold;
		border: 1px solid #2c3e50;
	}
	.sa-invoice table.items td {
		padding: 8px 10px;
		border: 1px solid #ddd;
	}
	.sa-invoice table.items tr:nth-child(even) {
		background-color: #f9f9f9;
	}
	.sa-invoice .text-right {
		text-align: right;
	}
	.sa-invoice .text-center {
		text-align: center;
	}
	.sa-invoice .totals-section {
		float: right;
		width: 40%;
		margin-top: 20px;
	}
	.sa-invoice .totals-table {
		width: 100%;
		border-collapse: collapse;
	}
	.sa-invoice .totals-table td {
		padding: 8px;
		border-bottom: 1px solid #ddd;
	}
	.sa-invoice .totals-table .label {
		text-align: right;
		font-weight: bold;
	}
	.sa-invoice .totals-table .amount {
		text-align: right;
		width: 40%;
	}
	.sa-invoice .totals-table .grand-total {
		font-size: 14pt;
		font-weight: bold;
		background-color: #34495e;
		color: white;
	}
	.sa-invoice .footer {
		clear: both;
		margin-top: 40px;
		padding-top: 20px;
		border-top: 2px solid #333;
	}
	.sa-invoice .terms {
		font-size: 9pt;
		color: #666;
		margin-top: 20px;
	}
	@media print {
		.sa-invoice {
			font-size: 10pt;
		}
	}
</style>

<div class="sa-invoice">
	<!-- Header Section -->
	<div class="header">
		<table style="width: 100%; border: none;">
			<tr>
				<td style="width: 50%; vertical-align: top; border: none;">
					{% if company_doc.company_logo %}
					<img src="{{ company_doc.company_logo }}" class="company-logo" alt="{{ company_doc.name }}">
					{% endif %}
					<div class="company-name">{{ company_doc.name }}</div>
					<div>{{ company_doc.address_line1 or "" }}</div>
					{% if company_doc.address_line2 %}
					<div>{{ company_doc.address_line2 }}</div>
					{% endif %}
					<div>{{ company_doc.city or "" }}{% if company_doc.state %}, {{ company_doc.state }}{% endif %} {{ company_doc.pincode or "" }}</div>
					<div>{{ company_doc.country or "" }}</div>
					{% if company_doc.phone %}
					<div>Phone: {{ company_doc.phone }}</div>
					{% endif %}
					{% if company_doc.email %}
					<div>Email: {{ company_doc.email }}</div>
					{% endif %}
				</td>
				<td style="width: 50%; vertical-align: top; text-align: right; border: none;">
					<div class="section-label">Supplier VAT Number</div>
					<div class="vat-number">{{ company_doc.tax_id or "Not Registered" }}</div>
					{% if company_doc.company_registration %}
					<div style="margin-top: 10px;">
						<strong>Reg No:</strong> {{ company_doc.company_registration }}
					</div>
					{% endif %}
				</td>
			</tr>
		</table>
	</div>

	<!-- Invoice Title -->
	<div class="invoice-title">{{ invoice_type }}</div>

	<!-- Bill To and Invoice Details -->
	<div class="address-section">
		<div class="bill-to">
			<div class="section-label">Bill To:</div>
			<div><strong>{{ doc.customer_name }}</strong></div>
			{% if not is_abridged %}
				{% if doc.address_display %}
					{{ doc.address_display | replace("\n", "<br>") | safe }}
				{% endif %}
				{% if doc.customer_tax_id %}
				<div style="margin-top: 8px;">
					<span class="section-label">Customer VAT Number:</span><br>
					<span class="vat-number">{{ doc.customer_tax_id }}</span>
				</div>
				{% endif %}
				{% if doc.contact_display %}
				<div style="margin-top: 8px;">
					<strong>Contact:</strong> {{ doc.contact_display }}
				</div>
				{% endif %}
				{% if doc.contact_mobile %}
				<div><strong>Mobile:</strong> {{ doc.contact_mobile }}</div>
				{% endif %}
				{% if doc.contact_email %}
				<div><strong>Email:</strong> {{ doc.contact_email }}</div>
				{% endif %}
			{% else %}
				<div style="font-style: italic; color: #666;">
					Abridged invoice - customer details not required
				</div>
			{% endif %}
		</div>
		<div class="invoice-details">
			<table style="width: 100%; border: none;">
				<tr>
					<td style="border: none; padding: 4px;"><div class="section-label">Invoice Number:</div></td>
					<td style="border: none; padding: 4px;"><strong>{{ doc.name }}</strong></td>
				</tr>
				<tr>
					<td style="border: none; padding: 4px;"><div class="section-label">Invoice Date:</div></td>
					<td style="border: none; padding: 4px;">{{ doc.get_formatted("posting_date") }}</td>
				</tr>
				<tr>
					<td style="border: none; padding: 4px;"><div class="section-label">Due Date:</div></td>
					<td style="border: none; padding: 4px;">{{ doc.get_formatted("due_date") }}</td>
				</tr>
				{% if doc.po_no %}
				<tr>
					<td style="border: none; padding: 4px;"><div class="section-label">PO Number:</div></td>
					<td style="border: none; padding: 4px;">{{ doc.po_no }}</td>
				</tr>
				{% endif %}
			</table>
		</div>
	</div>

	<!-- Items Table -->
	<table class="items">
		<thead>
			<tr>
				<th style="width: 5%;" class="text-center">No.</th>
				<th style="width: 45%;">Description</th>
				<th style="width: 10%;" class="text-center">Qty</th>
				<th style="width: 15%;" class="text-right">Unit Price</th>
				<th style="width: 10%;" class="text-center">VAT %</th>
				<th style="width: 15%;" class="text-right">Amount</th>
			</tr>
		</thead>
		<tbody>
			{% for item in doc.items %}
			<tr>
				<td class="text-center">{{ loop.index }}</td>
				<td>
					<strong>{{ item.item_code }}</strong>
					{% if item.item_name and item.item_name != item.item_code %}
					<br>{{ item.item_name }}
					{% endif %}
					{% if item.description and item.description != item.item_name %}
					<br><span style="font-size: 9pt; color: #666;">{{ item.description }}</span>
					{% endif %}
				</td>
				<td class="text-center">{{ item.qty }} {{ item.uom or "" }}</td>
				<td class="text-right">{{ item.get_formatted("rate") }}</td>
				<td class="text-center">
					{% set item_tax_rate = 0 %}
					{% if doc.taxes %}
						{% for tax in doc.taxes %}
							{% if "VAT" in tax.description or "Tax" in tax.description %}
								{% set item_tax_rate = tax.rate %}
							{% endif %}
						{% endfor %}
					{% endif %}
					{{ "%.1f"|format(item_tax_rate) }}%
				</td>
				<td class="text-right">{{ item.get_formatted("amount") }}</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>

	<!-- Totals Section -->
	<div class="totals-section">
		<table class="totals-table">
			<tr>
				<td class="label">Subtotal (Excl. VAT):</td>
				<td class="amount">{{ doc.get_formatted("net_total") }}</td>
			</tr>
			{% if doc.discount_amount and doc.discount_amount > 0 %}
			<tr>
				<td class="label">Discount:</td>
				<td class="amount">({{ doc.get_formatted("discount_amount") }})</td>
			</tr>
			{% endif %}
			{% for tax in doc.taxes %}
			<tr>
				<td class="label">
					{{ tax.description }}
					{% if tax.rate %}@ {{ "%.1f"|format(tax.rate) }}%{% endif %}:
				</td>
				<td class="amount">{{ tax.get_formatted("tax_amount") }}</td>
			</tr>
			{% endfor %}
			<tr class="grand-total">
				<td class="label">TOTAL (Incl. VAT):</td>
				<td class="amount">{{ doc.get_formatted("grand_total") }}</td>
			</tr>
			{% if doc.rounded_total %}
			<tr>
				<td class="label">Rounded Total:</td>
				<td class="amount">{{ doc.get_formatted("rounded_total") }}</td>
			</tr>
			{% endif %}
		</table>
	</div>

	<!-- Footer Section -->
	<div class="footer">
		{% if doc.payment_terms_template or doc.payment_schedule %}
		<div style="margin-bottom: 15px;">
			<div class="section-label">Payment Terms:</div>
			{% if doc.payment_terms_template %}
			<div>{{ doc.payment_terms_template }}</div>
			{% endif %}
		</div>
		{% endif %}

		{% if company_doc.default_bank_account %}
		{% set bank_account = frappe.get_doc("Bank Account", company_doc.default_bank_account) %}
		<div style="margin-bottom: 15px;">
			<div class="section-label">Banking Details:</div>
			<table style="border: none; font-size: 10pt;">
				<tr>
					<td style="border: none; padding: 2px;"><strong>Bank:</strong></td>
					<td style="border: none; padding: 2px;">{{ bank_account.bank or "" }}</td>
				</tr>
				<tr>
					<td style="border: none; padding: 2px;"><strong>Account Name:</strong></td>
					<td style="border: none; padding: 2px;">{{ bank_account.account_name or company_doc.name }}</td>
				</tr>
				<tr>
					<td style="border: none; padding: 2px;"><strong>Account Number:</strong></td>
					<td style="border: none; padding: 2px;">{{ bank_account.bank_account_no or "" }}</td>
				</tr>
				{% if bank_account.branch_code %}
				<tr>
					<td style="border: none; padding: 2px;"><strong>Branch Code:</strong></td>
					<td style="border: none; padding: 2px;">{{ bank_account.branch_code }}</td>
				</tr>
				{% endif %}
			</table>
		</div>
		{% endif %}

		{% if doc.terms %}
		<div class="terms">
			<div class="section-label">Terms and Conditions:</div>
			<div>{{ doc.terms }}</div>
		</div>
		{% endif %}

		<div style="margin-top: 20px; font-size: 9pt; color: #999; text-align: center;">
			This is a system-generated invoice. Sequential invoice numbering is maintained as per SARS requirements.<br>
			All invoices are retained for a minimum of 5 years for audit purposes.
		</div>
	</div>
</div>

